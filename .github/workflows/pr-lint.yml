name: PR Lint & Format Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write  # ç”¨äºåœ¨ PR ä¸­è¯„è®ºç»“æœ

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python & uv
        uses: ./.github/actions/setup-python

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node
        with:
          node-version: "24"

      - name: Install frontend dependencies
        run: |
          echo "ğŸ“¦ Installing frontend dependencies..."
          cd frontend
          pnpm install
          cd ..

      - name: Run unified lint script (check-only mode)
        run: |
          echo "ğŸš€ Running unified lint script in check-only mode..."
          uv run python scripts/lint.py --check-only

      - name: Run backend lint and format check
        if: always()
        run: |
          echo "ğŸ Checking backend Python code..."
          uv run ruff check --output-format=github

          echo "ğŸ¨ Checking backend Python format..."
          uv run ruff format --check --diff

      - name: Run frontend lint and format check
        if: always()
        run: |
          echo "ğŸ“± Checking frontend JavaScript/TypeScript code..."
          cd frontend
          pnpm lint

          echo "ğŸ¨ Checking frontend format..."
          pnpm format:check

          echo "ğŸ”· Running TypeScript type check..."
          pnpm type-check
          cd ..

      - name: Check for uncommitted changes
        if: always()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ There are uncommitted changes after running formatters!"
            echo "Please run the following locally to fix:"
            echo "  uv run python scripts/lint.py"
            echo ""
            echo "Or run the individual commands:"
            echo "  Backend: uv run ruff check --fix && uv run ruff format"
            echo "  Frontend: cd frontend && pnpm lint --fix && pnpm format"
            echo ""
            echo "Files with changes:"
            git status --porcelain
            exit 1
          else
            echo "âœ… No formatting changes detected"
          fi

      - name: Comment PR with results
        # åªåœ¨é fork PR æ—¶å°è¯•è¯„è®ºï¼ˆfork PR æ²¡æœ‰å†™æƒé™ï¼‰
        if: always() && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        continue-on-error: true  # å³ä½¿è¯„è®ºå¤±è´¥ä¹Ÿä¸é˜»å¡ workflow
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸš€ Lint & Format Check Results')
            );

            const status = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            const color = '${{ job.status }}' === 'success' ? 'green' : 'red';

            const commentBody = `
            ## ğŸš€ Lint & Format Check Results: ${status}

            ### What was checked:
            - ğŸ **Backend**: Ruff linting + formatting
            - ğŸ“± **Frontend**: ESLint + Prettier + TypeScript types
            - ğŸ”§ **Unified**: Custom lint script validation

            ${'${{ job.status }}' === 'success' ? `
            ### âœ… All checks passed!
            Your code follows the project's style guidelines.

            ### Checks performed:
            - Backend Ruff lint âœ…
            - Backend Ruff format âœ…
            - Frontend ESLint âœ…
            - Frontend Prettier format âœ…
            - Frontend TypeScript types âœ…
            - Unified lint script âœ…
            ` : `
            ### âŒ Some checks failed!

            #### How to fix:
            1. Run locally to auto-fix most issues:
            \`\`\`bash
            uv run python scripts/lint.py
            \`\`\`

            2. Commit the fixes and push:
            \`\`\`bash
            git add .
            git commit -m "fix: apply lint and format fixes"
            git push
            \`\`\`

            3. The checks will run again automatically.

            #### Individual fix commands:
            **Backend:**
            \`\`\`bash
            uv run ruff check --fix
            uv run ruff format
            \`\`\`

            **Frontend:**
            \`\`\`bash
            cd frontend
            pnpm lint --fix
            pnpm format
            cd ..
            \`\`\`
            `}

            ---
            *This is an automated check. For questions, ask in the PR discussion.*
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

  # æ„å»ºä»»åŠ¡ - ä»…åœ¨ lint é€šè¿‡åè¿è¡Œ
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint-and-format
    if: always() && needs.lint-and-format.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node
        with:
          node-version: "24"

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Build frontend
        run: |
          cd frontend
          pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7
